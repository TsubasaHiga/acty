---
/**
 * Local Picture Component
 */
import type { HTMLAttributes } from 'astro/types'

import { values } from '@/const/values'
import { getImageSize } from '@/utils/getImageSize'
import { getPathFromLocalPublic } from '@/utils/getPathFromLocalPublic'

export type ArtDirectiveType = {
  media: string
  srcset: string[]
  width?: number
  height?: number
}

export type SrcsetType = {
  sm?: string[]
  lg?: string[]
}

export interface Props extends HTMLAttributes<'picture'> {
  src: string
  srcset: SrcsetType
  width?: number
  height?: number
  alt?: string
  lazy?: boolean
  fetchpriority?: HTMLAttributes<'img'>['fetchpriority']
}
const { src, srcset, width: srcWidth, height: srcHeight, alt = '', lazy = true, fetchpriority, ...attr } = Astro.props

// srcの画像サイズを取得
// srcWidthとsrcHeightが指定されている場合はそれを優先
const { width, height } =
  srcWidth && srcHeight ? { width: srcWidth, height: srcHeight } : await getImageSize(getPathFromLocalPublic(src))

// srcsetをartDirectivesの形式に変換
// 各srcsetの画像サイズも自動取得
const artDirectives: ArtDirectiveType[] = await Promise.all(
  Object.entries(srcset).map(async ([key, srcset]) => {
    // srcset配列の最初の画像パスを取得（例: '/path/to/image.webp 1x' -> '/path/to/image.webp'）
    const firstImagePath = srcset[0]?.split(' ')[0]

    // 画像サイズを取得
    let sourceWidth: number | undefined
    let sourceHeight: number | undefined

    if (firstImagePath) {
      try {
        const size = await getImageSize(getPathFromLocalPublic(firstImagePath))
        sourceWidth = size.width ?? undefined
        sourceHeight = size.height ?? undefined
      } catch (error) {
        console.warn(`Failed to get image size for: ${firstImagePath}`, error)
      }
    }

    switch (key) {
      case 'sm':
        return {
          media: `(max-width: ${values.BREAKPOINT}px)`,
          srcset,
          width: sourceWidth,
          height: sourceHeight
        }
      case 'lg':
        return {
          media: `(min-width: ${values.BREAKPOINT + 1}px)`,
          srcset,
          width: sourceWidth,
          height: sourceHeight
        }
      default:
        return {
          media: '',
          srcset,
          width: sourceWidth,
          height: sourceHeight
        }
    }
  })
)
---

<picture {...attr}>
  {
    artDirectives.map(({ media, srcset, width, height }) => (
      <source media={media} srcset={srcset.join(', ')} width={width} height={height} />
    ))
  }
  <img
    src={src}
    height={height}
    width={width}
    alt={alt}
    loading={lazy ? 'lazy' : 'eager'}
    fetchpriority={fetchpriority}
  />
</picture>
